import re
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import os
from matplotlib.colors import LinearSegmentedColormap

def gerar_matrizes_globais_premium(caminho_txt):
    # 1. Preparação
    pasta_destino = 'matriz_global'
    if not os.path.exists(pasta_destino):
        os.makedirs(pasta_destino)

    if not os.path.exists(caminho_txt):
        print(f"Erro: Arquivo {caminho_txt} não encontrado.")
        return

    with open(caminho_txt, 'r', encoding='utf-8', errors='ignore') as f:
        texto_limpo = "".join(i for i in f.read() if ord(i) < 128)

    # 2. Extração e Acumulação Global
    padrao = r"RESULTADOS:\s*(NORMAL|FUZZY)_(.*?)_(H\d+).*?\[\[(.*?)]]"
    blocos = re.findall(padrao, texto_limpo, re.S)

    # Acumuladores globais
    global_normal = np.zeros((3, 3), dtype=int)
    global_fuzzy = np.zeros((3, 3), dtype=int)

    for b in blocos:
        tipo = b[0].upper()
        nums = re.findall(r"\d+", b[3])
        if len(nums) == 9:
            matriz = np.array([int(n) for n in nums]).reshape(3, 3)
            if tipo == 'NORMAL':
                global_normal += matriz
            elif tipo == 'FUZZY':
                global_fuzzy += matriz

    # 3. Configuração Estética
    cores_amarelas = ["#FFFBEE", "#FFD700", "#B8860B"] 
    cmap_premium = LinearSegmentedColormap.from_list("gold", cores_amarelas)
    labels_eixo = ['0', '1', '2']

    def salvar_matriz(matriz, titulo, nome_arq):
        plt.figure(figsize=(8, 6))
        sns.heatmap(matriz, annot=True, fmt='d', cmap=cmap_premium, cbar=True,
                    xticklabels=labels_eixo, yticklabels=labels_eixo,
                    annot_kws={"color": "black", "fontweight": "bold", "size": 14})
        
        plt.title(titulo, fontweight='bold', fontsize=16, pad=20)
        plt.xlabel('Previsão do Modelo', fontsize=12)
        plt.ylabel('Realidade do Mercado', fontsize=12)
        plt.tight_layout()
        plt.savefig(os.path.join(pasta_destino, nome_arq), dpi=150)
        plt.close()

    # 4. Geração dos arquivos finais
    if np.sum(global_normal) > 0:
        salvar_matriz(global_normal, "MATRIZ GLOBAL: MODELO NORMAL", "global_normal.png")
        print(" Matriz Global NORMAL gerada.")
    
    if np.sum(global_fuzzy) > 0:
        salvar_matriz(global_fuzzy, "MATRIZ GLOBAL: MODELO FUZZY", "global_fuzzy.png")
        print(" Matriz Global FUZZY gerada.")

    print(f"\n Pronto! As matrizes de erro e acerto globais estão na pasta '{pasta_destino}'.")

# EXECUÇÃO
gerar_matrizes_globais_premium('resultados_completos_discretizacao.txt')